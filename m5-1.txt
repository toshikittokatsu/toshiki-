<!DOCTYPE html>
<html lang=ja>
<head>
    <meta charset="UTF-8">
    <title>mission_5-1</title>
</head>
<body>

<?php

  //データベースへ接続
    $dsn='データベース名';
    $user='ユーザー名';
    $password='パスワード';
    $pdo=new PDO($dsn,$user,$password,array(PDO::ATTR_ERRMODE=>PDO::ERRMODE_WARNING));

  //データベース内にテーブルを作成
  $sql = "CREATE TABLE IF NOT EXISTS tb_4"
    . "("
    . "id INT AUTO_INCREMENT PRIMARY KEY,"
    . "name CHAR(32),"
    . "comment VARCHAR(100),"
    . "date CHAR(100),"
    . "password CHAR(30)"
    . ")";
    $stmt = $pdo->query($sql);

  //変数に代入
  $date = date("Y/m/d/ H:i:s");

  //送信ボタンが押されたとき
  if(!empty($_POST['submit'])) {
    $name = $_POST['name'];
    $comment = $_POST['comment'];
    $pass = $_POST['pass'];
    $editnum = $_POST['editnum'];
  }

  //削除ボタンが押されたとき
  if(!empty($_POST['delete'])) {
    $delete = $_POST['delete'];
    $delpass = $_POST['delpass'];
  }

  //編集ボタンが押されたとき
  if(!empty($_POST['edit'])) {
    $edit = $_POST['edit'];
    $editpass = $_POST['editpass'];
  }

   //削除機能
  if(!empty($_POST['delete']) && !empty($_POST['delpass'] )) { 
    $sql = 'SELECT * FROM tb_4 WHERE id=:id';
    $stmt = $pdo->prepare($sql);
    $stmt->bindParam(':id', $delete, PDO::PARAM_INT); 
    $stmt->execute();
    $results = $stmt->fetchAll();
    foreach ($results as $row) {
        if ($delpass == $row['password']){
            $sql = 'DELETE FROM tb_4 WHERE id=:id';
            $stmt = $pdo->prepare($sql);
            $stmt->bindParam(':id', $delete, PDO::PARAM_INT);
            $stmt->execute();
        }else{
            echo "パスワードが違います<br>";
        }
    }  
}

  //編集機能
  if(!empty($_POST['edit']) && !empty($_POST['editpass'] )) {
    $sql = 'SELECT * FROM tb_4 WHERE id=:id';
    $stmt = $pdo->prepare($sql);
    $stmt->bindParam(':id', $editnum, PDO::PARAM_INT); 
    $stmt->execute();
    $results = $stmt->fetchAll();
    foreach($results as $row) {
      if($editpass == $row['password']) {
        $editnum = $row['id'];
        $edName = $row['name'];
        $edComment = $row['comment'];
        $editpass_form = $row['password'];
      } else {
           echo "パスワードが違います<br>";
      }
    }
  }



 //名前とコメントとパスワードがあるなら
 if(!empty($name) && !empty($comment)){

  //編集番号が送信されたなら編集モード
  if(!empty($editnum)) {
      $sql = 'UPDATE tb_4 SET name=:name,comment=:comment,password=:password,date=:date WHERE id=:id';
      $stmt = $pdo->prepare($sql);
      $stmt->bindParam(':name', $name, PDO::PARAM_STR);
      $stmt->bindParam(':comment', $comment, PDO::PARAM_STR);
      $stmt->bindParam(':password', $pass, PDO::PARAM_STR);
      $stmt->bindParam(':date', $date, PDO::PARAM_STR);
      $stmt->bindParam(':id', $editnum, PDO::PARAM_INT);
      $stmt->execute();

  //編集番号が送信されてないなら追記モード
  }else{    
      $sql = $pdo -> prepare("INSERT INTO tb_4 (name,comment,date,password) VALUES (:name,:comment,:date,:password)");
      $sql -> bindParam(':name', $name, PDO::PARAM_STR);
      $sql -> bindParam(':comment', $comment, PDO::PARAM_STR);
      $sql -> bindParam(':date', $date, PDO::PARAM_STR);
      $sql -> bindParam(':password', $pass, PDO::PARAM_STR);
      $sql -> execute();
  }
}
?>

<form action="" method="post">
  <input type="text" name="name"
  placeholder="名前" value="<?php if(!empty($edName)){echo $edName;}?>">
  <br>
  <input type="text" name="comment"
   placeholder="コメント" value="<?php if(!empty($edComment)){echo $edComment;} ?>">
   <input type="hidden" name="editnum" placeholder=""
   value="<?php if(!empty($edit)){echo $edit;} ?>">
   <br>
   <input type="text" name="pass" placeholder="パスワード">
   <input type="submit" name="submit" >
   <br>
   <hr>

  <input type="text" name="delete" placeholder="削除対象番号">
   <br>
   <input type="text" name="delpass" placeholder="パスワード">
   <input type="submit" name="submit" value="削除" >
   <br>
   <hr>

   <input type="text" name="edit" placeholder="編集対象番号">
   <br>
   <input type="text" name="editpass" placeholder="パスワード">
   <input type="submit" name="submit" value="編集">
  <hr>
</form>

  <?php
    $sql = 'SELECT * FROM tb_4';
    $stmt = $pdo->query($sql);
    $results = $stmt->fetchAll();
    foreach ($results as $row){
        echo $row['id'].' ';
        echo $row['name'].' ';
        echo $row['comment'].' ';
        echo $row['date'].' ';
        echo $row['password'].'<br>';
        echo '<hr>';
    }
  ?>

</body>
</html>
